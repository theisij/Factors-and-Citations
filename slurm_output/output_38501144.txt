-------------------------------
/gpfs/gibbs/project/tjensen/tij2/Factors-and-Citations
Running on host r909u07n01.grace.ycrc.yale.edu
Time is Tue Mar 12 04:46:15 EDT 2024
SLURM_NODES are r909u07n01
-------------------------------




> char_info <- setDT(mutate(filter(select(readxl::read_xlsx("Paper/Factor Details_revision1.xlsx", 
+     sheet = "details"), characteristic = abr_jkp .... [TRUNCATED] 

> new_class <- setDT(readxl::read_xlsx("Paper/new_classification.xlsx") %>% 
+     select(characteristic = abr_jkp, cite, paper_about = `Paper is abou .... [TRUNCATED] 

> cluster_labels <- new_class[, .(characteristic, cluster = factor_about)][!is.na(characteristic)]

> char_info <- char_info[cluster_labels, on = "characteristic"]

> if (set$sub_chars) {
+     char_info <- char_info[characteristic %in% c("ret_12_1", 
+         "be_me", "market_equity")]
+ }

> features <- c(char_info$characteristic, "rvol_252d")

> countries <- setDT(readxl::read_xlsx("Data/Country Classification.xlsx"))

> if (set$sub_cntry) {
+     countries <- countries[excntry %in% c("GBR", "USA", "THA")]
+ } else {
+     countries <- countries[msci_development %in% .... [TRUNCATED] 

> ret_cutoffs <- fread("Data/return_cutoffs.csv", colClasses = c(eom = "character"))

> ret_cutoffs[, `:=`(eom, eom %>% lubridate::fast_strptime(format = "%Y%m%d") %>% 
+     as.Date())]

> ret_cutoffs <- ret_cutoffs[, .(eom, wins_high = ret_exc_99, 
+     wins_low = ret_exc_1)]

> ret_cutoffs[, `:=`(eom, eom + 1 - months(1) - 1)]

> chars <- rbindlist(map(countries$excntry, function(cntry) {
+     print(cntry)
+     chars_cntry <- fread(paste0(chars_path, str_to_lower(cntry), 
+ .... [TRUNCATED] 
[1] "USA"
[1] "   Date screen excludes 36.97% of the observations"
[1] "   Non-missing me and ret_1m excludes 2.74% of the observations"
[1] "   Size screen excludes 0% of the observations"
[1] "   At least 50% of feature excludes 8.78% of the observations"
[1] "   In total, the final dataset has 88.72% of the observations and 99.26% of the market cap in the post  data"
[1] "CHN"
[1] "   Date screen excludes 0.74% of the observations"
[1] "   Non-missing me and ret_1m excludes 0.81% of the observations"
[1] "   Size screen excludes 0% of the observations"
[1] "   At least 50% of feature excludes 1.62% of the observations"
[1] "   In total, the final dataset has 97.58% of the observations and 98.18% of the market cap in the post  data"
[1] "JPN"
[1] "   Date screen excludes 0.28% of the observations"
[1] "   Non-missing me and ret_1m excludes 0.45% of the observations"
[1] "   Size screen excludes 0% of the observations"
[1] "   At least 50% of feature excludes 26.72% of the observations"
[1] "   In total, the final dataset has 72.95% of the observations and 86.24% of the market cap in the post  data"
[1] "HKG"
[1] "   Date screen excludes 0.51% of the observations"
[1] "   Non-missing me and ret_1m excludes 0.77% of the observations"
[1] "   Size screen excludes 0% of the observations"
[1] "   At least 50% of feature excludes 12.05% of the observations"
[1] "   In total, the final dataset has 87.27% of the observations and 96.98% of the market cap in the post  data"
[1] "GBR"
[1] "   Date screen excludes 0.19% of the observations"
[1] "   Non-missing me and ret_1m excludes 2.35% of the observations"
[1] "   Size screen excludes 0% of the observations"
[1] "   At least 50% of feature excludes 30.47% of the observations"
[1] "   In total, the final dataset has 67.89% of the observations and 94.61% of the market cap in the post  data"
[1] "IND"
[1] "   Date screen excludes 0.59% of the observations"
[1] "   Non-missing me and ret_1m excludes 2.95% of the observations"
[1] "   Size screen excludes 0% of the observations"
[1] "   At least 50% of feature excludes 16.97% of the observations"
[1] "   In total, the final dataset has 80.57% of the observations and 94.55% of the market cap in the post  data"
[1] "TWN"
[1] "   Date screen excludes 0.46% of the observations"
[1] "   Non-missing me and ret_1m excludes 0.45% of the observations"
[1] "   Size screen excludes 0% of the observations"
[1] "   At least 50% of feature excludes 15.24% of the observations"
[1] "   In total, the final dataset has 84.38% of the observations and 88.41% of the market cap in the post  data"
[1] "KOR"
[1] "   Date screen excludes 0.47% of the observations"
[1] "   Non-missing me and ret_1m excludes 0.63% of the observations"
[1] "   Size screen excludes 0% of the observations"
[1] "   At least 50% of feature excludes 46.57% of the observations"
[1] "   In total, the final dataset has 53.09% of the observations and 87.36% of the market cap in the post  data"
[1] "CAN"
[1] "   Date screen excludes 2.37% of the observations"
[1] "   Non-missing me and ret_1m excludes 53.81% of the observations"
[1] "   Size screen excludes 0% of the observations"
[1] "   At least 50% of feature excludes 26.24% of the observations"
[1] "   In total, the final dataset has 34.07% of the observations and 92.31% of the market cap in the post  data"
[1] "AUS"
[1] "   Date screen excludes 0.37% of the observations"
[1] "   Non-missing me and ret_1m excludes 1.73% of the observations"
[1] "   Size screen excludes 0% of the observations"
[1] "   At least 50% of feature excludes 17.57% of the observations"
[1] "   In total, the final dataset has 81% of the observations and 95.94% of the market cap in the post  data"
[1] "DEU"
[1] "   Date screen excludes 0.25% of the observations"
[1] "   Non-missing me and ret_1m excludes 1.62% of the observations"
[1] "   Size screen excludes 0% of the observations"
[1] "   At least 50% of feature excludes 26.93% of the observations"
[1] "   In total, the final dataset has 71.88% of the observations and 94.34% of the market cap in the post  data"
[1] "FRA"
[1] "   Date screen excludes 0.27% of the observations"
[1] "   Non-missing me and ret_1m excludes 2.33% of the observations"
[1] "   Size screen excludes 0% of the observations"
[1] "   At least 50% of feature excludes 23.24% of the observations"
[1] "   In total, the final dataset has 74.97% of the observations and 94.92% of the market cap in the post  data"
[1] "SWE"
[1] "   Date screen excludes 0.62% of the observations"
[1] "   Non-missing me and ret_1m excludes 0.9% of the observations"
[1] "   Size screen excludes 0% of the observations"
[1] "   At least 50% of feature excludes 10.13% of the observations"
[1] "   In total, the final dataset has 89.06% of the observations and 97.69% of the market cap in the post  data"
[1] "CHE"
[1] "   Date screen excludes 0.26% of the observations"
[1] "   Non-missing me and ret_1m excludes 1.43% of the observations"
[1] "   Size screen excludes 0% of the observations"
[1] "   At least 50% of feature excludes 17.26% of the observations"
[1] "   In total, the final dataset has 81.56% of the observations and 96.43% of the market cap in the post  data"
[1] "THA"
[1] "   Date screen excludes 0.42% of the observations"
[1] "   Non-missing me and ret_1m excludes 1.29% of the observations"
[1] "   Size screen excludes 0% of the observations"
[1] "   At least 50% of feature excludes 24.21% of the observations"
[1] "   In total, the final dataset has 74.81% of the observations and 90.94% of the market cap in the post  data"
[1] "IDN"
[1] "   Date screen excludes 0.59% of the observations"
[1] "   Non-missing me and ret_1m excludes 3.1% of the observations"
[1] "   Size screen excludes 0% of the observations"
[1] "   At least 50% of feature excludes 21.52% of the observations"
[1] "   In total, the final dataset has 76.05% of the observations and 94.99% of the market cap in the post  data"
[1] "BRA"
[1] "   Date screen excludes 0.56% of the observations"
[1] "   Non-missing me and ret_1m excludes 2.45% of the observations"
[1] "   Size screen excludes 0% of the observations"
[1] "   At least 50% of feature excludes 9.74% of the observations"
[1] "   In total, the final dataset has 88.05% of the observations and 72.71% of the market cap in the post  data"
[1] "SGP"
[1] "   Date screen excludes 0.26% of the observations"
[1] "   Non-missing me and ret_1m excludes 1.71% of the observations"
[1] "   Size screen excludes 0% of the observations"
[1] "   At least 50% of feature excludes 13.42% of the observations"
[1] "   In total, the final dataset has 85.1% of the observations and 94.87% of the market cap in the post  data"
[1] "MYS"
[1] "   Date screen excludes 0.32% of the observations"
[1] "   Non-missing me and ret_1m excludes 0.59% of the observations"
[1] "   Size screen excludes 0% of the observations"
[1] "   At least 50% of feature excludes 12.81% of the observations"
[1] "   In total, the final dataset has 86.68% of the observations and 93.75% of the market cap in the post  data"
[1] "ITA"
[1] "   Date screen excludes 0.38% of the observations"
[1] "   Non-missing me and ret_1m excludes 0.92% of the observations"
[1] "   Size screen excludes 0% of the observations"
[1] "   At least 50% of feature excludes 21.97% of the observations"
[1] "   In total, the final dataset has 77.31% of the observations and 93.21% of the market cap in the post  data"
[1] "ZAF"
[1] "   Date screen excludes 0.17% of the observations"
[1] "   Non-missing me and ret_1m excludes 2.91% of the observations"
[1] "   Size screen excludes 0% of the observations"
[1] "   At least 50% of feature excludes 38.23% of the observations"
[1] "   In total, the final dataset has 59.97% of the observations and 88.21% of the market cap in the post  data"
[1] "ESP"
[1] "   Date screen excludes 0.38% of the observations"
[1] "   Non-missing me and ret_1m excludes 2.11% of the observations"
[1] "   Size screen excludes 0% of the observations"
[1] "   At least 50% of feature excludes 28.79% of the observations"
[1] "   In total, the final dataset has 69.71% of the observations and 95.43% of the market cap in the post  data"
[1] "MEX"
[1] "   Date screen excludes 0.31% of the observations"
[1] "   Non-missing me and ret_1m excludes 4.68% of the observations"
[1] "   Size screen excludes 0% of the observations"
[1] "   At least 50% of feature excludes 21.14% of the observations"
[1] "   In total, the final dataset has 75.17% of the observations and 93.11% of the market cap in the post  data"
[1] "RUS"
[1] "   Date screen excludes 0% of the observations"
[1] "   Non-missing me and ret_1m excludes 4.66% of the observations"
[1] "   Size screen excludes 0% of the observations"
[1] "   At least 50% of feature excludes 25.57% of the observations"
[1] "   In total, the final dataset has 70.96% of the observations and 93.98% of the market cap in the post  data"
[1] "ISR"
[1] "   Date screen excludes 0.46% of the observations"
[1] "   Non-missing me and ret_1m excludes 1.58% of the observations"
[1] "   Size screen excludes 0% of the observations"
[1] "   At least 50% of feature excludes 26.14% of the observations"
[1] "   In total, the final dataset has 72.7% of the observations and 92.9% of the market cap in the post  data"
[1] "SAU"
[1] "   Date screen excludes 0.78% of the observations"
[1] "   Non-missing me and ret_1m excludes 0.43% of the observations"
[1] "   Size screen excludes 0% of the observations"
[1] "   At least 50% of feature excludes 11.3% of the observations"
[1] "   In total, the final dataset has 88.32% of the observations and 96.73% of the market cap in the post  data"
[1] "NLD"
[1] "   Date screen excludes 0.16% of the observations"
[1] "   Non-missing me and ret_1m excludes 1.31% of the observations"
[1] "   Size screen excludes 0% of the observations"
[1] "   At least 50% of feature excludes 26.75% of the observations"
[1] "   In total, the final dataset has 72.29% of the observations and 96.48% of the market cap in the post  data"
[1] "PHL"
[1] "   Date screen excludes 0.36% of the observations"
[1] "   Non-missing me and ret_1m excludes 2.79% of the observations"
[1] "   Size screen excludes 0% of the observations"
[1] "   At least 50% of feature excludes 27.04% of the observations"
[1] "   In total, the final dataset has 70.93% of the observations and 93.12% of the market cap in the post  data"
[1] "NOR"
[1] "   Date screen excludes 0.42% of the observations"
[1] "   Non-missing me and ret_1m excludes 1.71% of the observations"
[1] "   Size screen excludes 0% of the observations"
[1] "   At least 50% of feature excludes 18.71% of the observations"
[1] "   In total, the final dataset has 79.9% of the observations and 96.47% of the market cap in the post  data"
[1] "CHL"
[1] "   Date screen excludes 0.34% of the observations"
[1] "   Non-missing me and ret_1m excludes 5.99% of the observations"
[1] "   Size screen excludes 0% of the observations"
[1] "   At least 50% of feature excludes 24.51% of the observations"
[1] "   In total, the final dataset has 70.97% of the observations and 91.34% of the market cap in the post  data"
[1] "BEL"
[1] "   Date screen excludes 0.33% of the observations"
[1] "   Non-missing me and ret_1m excludes 2.45% of the observations"
[1] "   Size screen excludes 0% of the observations"
[1] "   At least 50% of feature excludes 26.34% of the observations"
[1] "   In total, the final dataset has 71.85% of the observations and 92.75% of the market cap in the post  data"
[1] "TUR"
[1] "   Date screen excludes 0.48% of the observations"
[1] "   Non-missing me and ret_1m excludes 0.42% of the observations"
[1] "   Size screen excludes 0% of the observations"
[1] "   At least 50% of feature excludes 25.83% of the observations"
[1] "   In total, the final dataset has 73.86% of the observations and 91.97% of the market cap in the post  data"
[1] "DNK"
[1] "   Date screen excludes 0.27% of the observations"
[1] "   Non-missing me and ret_1m excludes 1.38% of the observations"
[1] "   Size screen excludes 0% of the observations"
[1] "   At least 50% of feature excludes 21.53% of the observations"
[1] "   In total, the final dataset has 77.38% of the observations and 96.83% of the market cap in the post  data"
[1] "FIN"
[1] "   Date screen excludes 0.37% of the observations"
[1] "   Non-missing me and ret_1m excludes 0.81% of the observations"
[1] "   Size screen excludes 0% of the observations"
[1] "   At least 50% of feature excludes 12.17% of the observations"
[1] "   In total, the final dataset has 87.12% of the observations and 97.87% of the market cap in the post  data"
[1] "ARE"
[1] "   Date screen excludes 0.66% of the observations"
[1] "   Non-missing me and ret_1m excludes 5.33% of the observations"
[1] "   Size screen excludes 0% of the observations"
[1] "   At least 50% of feature excludes 33.01% of the observations"
[1] "   In total, the final dataset has 63.42% of the observations and 83.3% of the market cap in the post  data"
[1] "POL"
[1] "   Date screen excludes 0.45% of the observations"
[1] "   Non-missing me and ret_1m excludes 1.52% of the observations"
[1] "   Size screen excludes 0% of the observations"
[1] "   At least 50% of feature excludes 17.03% of the observations"
[1] "   In total, the final dataset has 81.71% of the observations and 95.39% of the market cap in the post  data"
[1] "NZL"
[1] "   Date screen excludes 0.26% of the observations"
[1] "   Non-missing me and ret_1m excludes 1.69% of the observations"
[1] "   Size screen excludes 0% of the observations"
[1] "   At least 50% of feature excludes 27% of the observations"
[1] "   In total, the final dataset has 71.77% of the observations and 93.02% of the market cap in the post  data"
[1] "AUT"
[1] "   Date screen excludes 0.2% of the observations"
[1] "   Non-missing me and ret_1m excludes 2.55% of the observations"
[1] "   Size screen excludes 0% of the observations"
[1] "   At least 50% of feature excludes 32.47% of the observations"
[1] "   In total, the final dataset has 65.81% of the observations and 91.87% of the market cap in the post  data"
[1] "QAT"
[1] "   Date screen excludes 0.53% of the observations"
[1] "   Non-missing me and ret_1m excludes 0.32% of the observations"
[1] "   Size screen excludes 0% of the observations"
[1] "   At least 50% of feature excludes 18.1% of the observations"
[1] "   In total, the final dataset has 81.63% of the observations and 88.56% of the market cap in the post  data"
[1] "PER"
[1] "   Date screen excludes 0.42% of the observations"
[1] "   Non-missing me and ret_1m excludes 8.39% of the observations"
[1] "   Size screen excludes 0% of the observations"
[1] "   At least 50% of feature excludes 29.39% of the observations"
[1] "   In total, the final dataset has 64.69% of the observations and 90.15% of the market cap in the post  data"
[1] "COL"
[1] "   Date screen excludes 0.38% of the observations"
[1] "   Non-missing me and ret_1m excludes 5.51% of the observations"
[1] "   Size screen excludes 0% of the observations"
[1] "   At least 50% of feature excludes 37.57% of the observations"
[1] "   In total, the final dataset has 58.99% of the observations and 90.09% of the market cap in the post  data"
[1] "GRC"
[1] "   Date screen excludes 0.2% of the observations"
[1] "   Non-missing me and ret_1m excludes 2.16% of the observations"
[1] "   Size screen excludes 0% of the observations"
[1] "   At least 50% of feature excludes 31.12% of the observations"
[1] "   In total, the final dataset has 67.39% of the observations and 83.81% of the market cap in the post  data"
[1] "PAK"
[1] "   Date screen excludes 0.39% of the observations"
[1] "   Non-missing me and ret_1m excludes 4.19% of the observations"
[1] "   Size screen excludes 0% of the observations"
[1] "   At least 50% of feature excludes 27.96% of the observations"
[1] "   In total, the final dataset has 69.03% of the observations and 89.71% of the market cap in the post  data"
[1] "IRL"
[1] "   Date screen excludes 0.12% of the observations"
[1] "   Non-missing me and ret_1m excludes 6.89% of the observations"
[1] "   Size screen excludes 0% of the observations"
[1] "   At least 50% of feature excludes 22.83% of the observations"
[1] "   In total, the final dataset has 71.85% of the observations and 95.59% of the market cap in the post  data"
[1] "EGY"
[1] "   Date screen excludes 0.46% of the observations"
[1] "   Non-missing me and ret_1m excludes 1.74% of the observations"
[1] "   Size screen excludes 0% of the observations"
[1] "   At least 50% of feature excludes 33.99% of the observations"
[1] "   In total, the final dataset has 64.87% of the observations and 81.75% of the market cap in the post  data"
[1] "ARG"
[1] "   Date screen excludes 0.24% of the observations"
[1] "   Non-missing me and ret_1m excludes 4.36% of the observations"
[1] "   Size screen excludes 0% of the observations"
[1] "   At least 50% of feature excludes 27.61% of the observations"
[1] "   In total, the final dataset has 69.23% of the observations and 44.73% of the market cap in the post  data"
[1] "PRT"
[1] "   Date screen excludes 0.22% of the observations"
[1] "   Non-missing me and ret_1m excludes 3.01% of the observations"
[1] "   Size screen excludes 0% of the observations"
[1] "   At least 50% of feature excludes 31.96% of the observations"
[1] "   In total, the final dataset has 66% of the observations and 93.83% of the market cap in the post  data"
[1] "CZE"
[1] "   Date screen excludes 0.14% of the observations"
[1] "   Non-missing me and ret_1m excludes 8.95% of the observations"
[1] "   Size screen excludes 0% of the observations"
[1] "   At least 50% of feature excludes 77.63% of the observations"
[1] "   In total, the final dataset has 20.37% of the observations and 89.05% of the market cap in the post  data"
[1] "HUN"
[1] "   Date screen excludes 0.37% of the observations"
[1] "   Non-missing me and ret_1m excludes 3.53% of the observations"
[1] "   Size screen excludes 0% of the observations"
[1] "   At least 50% of feature excludes 49.82% of the observations"
[1] "   In total, the final dataset has 48.41% of the observations and 92.74% of the market cap in the post  data"

> if (set$feat_prank) {
+     chars[, `:=`((features), lapply(.SD, as.double)), .SDcols = features]
+     for (f in features) {
+         if (match(f, .... [TRUNCATED] 
[1] "Feature 10 out of 154"
[1] "Feature 20 out of 154"
[1] "Feature 30 out of 154"
[1] "Feature 40 out of 154"
[1] "Feature 50 out of 154"
[1] "Feature 60 out of 154"
[1] "Feature 70 out of 154"
[1] "Feature 80 out of 154"
[1] "Feature 90 out of 154"
[1] "Feature 100 out of 154"
[1] "Feature 110 out of 154"
[1] "Feature 120 out of 154"
[1] "Feature 130 out of 154"
[1] "Feature 140 out of 154"
[1] "Feature 150 out of 154"

> if (set$feat_impute) {
+     if (set$feat_prank) {
+         chars[, `:=`((features), lapply(.SD, function(x) if_else(is.na(x), 
+             0.5,  .... [TRUNCATED] 

> clusters <- unique(char_info$cluster)

> cluster_ranks <- clusters %>% map(function(cl) {
+     chars_sub <- char_info[cluster == cl]
+     data_sub <- chars[, chars_sub$characteristic, wit .... [TRUNCATED] 

> chars <- cbind(chars[, .(excntry, id, eom, rvol_perc = rvol_252d, 
+     me_perc = market_equity, me, ret_exc_lead1m)], cluster_ranks)

> chars[, `:=`((clusters), lapply(.SD, function(x) ecdf(x)(x))), 
+     .SDcols = clusters, by = eom]
[1] "Value: 1 of 34"
[1] "Low risk: 2 of 34"
[1] "Momentum: 3 of 34"
[1] "Illiquidity: 4 of 34"
[1] "Long-run reversal: 5 of 34"
[1] "Size: 6 of 34"
[1] "Profitability: 7 of 34"
[1] "Fundamental growth: 8 of 34"
[1] "Accruals: 9 of 34"
[1] "Information quality: 10 of 34"
[1] "Short-term reversal: 11 of 34"
[1] "Skewness: 12 of 34"
[1] "R&D: 13 of 34"
[1] "Leverage: 14 of 34"
[1] "Investment: 15 of 34"
[1] "Asset growth: 16 of 34"
[1] "Combinations (quality): 17 of 34"
[1] "Financial constraints: 18 of 34"
[1] "PEAD: 19 of 34"
[1] "Low default risk: 20 of 34"
[1] "Equity issuance: 21 of 34"
[1] "Earnings increases: 22 of 34"
[1] "Combinations (mispricing): 23 of 34"
[1] "Taxes and returns: 24 of 34"
[1] "Firm issuance: 25 of 34"
[1] "Debt issuance: 26 of 34"
[1] "Age: 27 of 34"
[1] "Operating leverage: 28 of 34"
[1] "cash holdings: 29 of 34"
[1] "Duration: 30 of 34"
[1] "Seasonality: 31 of 34"
[1] "Real asset illiquidity: 32 of 34"
[1] "Inventory growth: 33 of 34"
[1] "Tax growth: 34 of 34"
