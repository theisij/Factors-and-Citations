-------------------------------
/gpfs/gibbs/project/tjensen/tij2/Factors-and-Citations
Running on host r909u04n02.grace.ycrc.yale.edu
Time is Mon Mar 11 14:53:16 EDT 2024
SLURM_NODES are r909u04n02
-------------------------------




> char_info <- setDT(mutate(filter(select(readxl::read_xlsx("Paper/Factor Details_revision1.xlsx", 
+     sheet = "details"), characteristic = abr_jkp .... [TRUNCATED] 

> new_class <- setDT(readxl::read_xlsx("Paper/new_classification.xlsx") %>% 
+     select(characteristic = abr_jkp, cite, paper_about = `Paper is abou .... [TRUNCATED] 

> cluster_labels <- new_class[, .(characteristic, cluster = factor_about)][!is.na(characteristic)]

> char_info <- char_info[cluster_labels, on = "characteristic"]

> if (set$sub_chars) {
+     char_info <- char_info[characteristic %in% c("ret_12_1", 
+         "be_me", "market_equity")]
+ }

> features <- c(char_info$characteristic, "rvol_252d")

> countries <- setDT(readxl::read_xlsx("Data/Country Classification.xlsx"))

> if (set$sub_cntry) {
+     countries <- countries[excntry %in% c("GBR", "USA", "THA")]
+ } else {
+     countries <- countries[msci_development %in% .... [TRUNCATED] 

> ret_cutoffs <- fread("Data/return_cutoffs.csv", colClasses = c(eom = "character"))

> ret_cutoffs[, `:=`(eom, eom %>% lubridate::fast_strptime(format = "%Y%m%d") %>% 
+     as.Date())]

> ret_cutoffs <- ret_cutoffs[, .(eom, wins_high = ret_exc_99, 
+     wins_low = ret_exc_1)]

> ret_cutoffs[, `:=`(eom, eom + 1 - months(1) - 1)]

> chars <- rbindlist(map(countries$excntry, function(cntry) {
+     print(cntry)
+     chars_cntry <- fread(paste0(chars_path, str_to_lower(cntry), 
+ .... [TRUNCATED] 
[1] "USA"
[1] "   Date screen excludes 37.4% of the observations"
[1] "   Non-missing me and ret_1m excludes 3.06% of the observations"
[1] "   Size screen excludes 0% of the observations"
[1] "   At least 50% of feature excludes 8.73% of the observations"
[1] "   In total, the final dataset has 88.47% of the observations and 98.65% of the market cap in the post  data"
[1] "CHN"
[1] "   Date screen excludes 0% of the observations"
[1] "   Non-missing me and ret_1m excludes 1.62% of the observations"
[1] "   Size screen excludes 0% of the observations"
[1] "   At least 50% of feature excludes 1.74% of the observations"
[1] "   In total, the final dataset has 96.67% of the observations and 96.98% of the market cap in the post  data"
[1] "JPN"
[1] "   Date screen excludes 0% of the observations"
[1] "   Non-missing me and ret_1m excludes 0.72% of the observations"
[1] "   Size screen excludes 0% of the observations"
[1] "   At least 50% of feature excludes 27.1% of the observations"
[1] "   In total, the final dataset has 72.38% of the observations and 85.53% of the market cap in the post  data"
[1] "HKG"
[1] "   Date screen excludes 0% of the observations"
[1] "   Non-missing me and ret_1m excludes 1.29% of the observations"
[1] "   Size screen excludes 0% of the observations"
[1] "   At least 50% of feature excludes 12.41% of the observations"
[1] "   In total, the final dataset has 86.46% of the observations and 96.23% of the market cap in the post  data"
[1] "GBR"
[1] "   Date screen excludes 0% of the observations"
[1] "   Non-missing me and ret_1m excludes 2.56% of the observations"
[1] "   Size screen excludes 0% of the observations"
[1] "   At least 50% of feature excludes 30.76% of the observations"
[1] "   In total, the final dataset has 67.47% of the observations and 94.19% of the market cap in the post  data"
[1] "IND"
[1] "   Date screen excludes 0% of the observations"
[1] "   Non-missing me and ret_1m excludes 3.14% of the observations"
[1] "   Size screen excludes 0% of the observations"
[1] "   At least 50% of feature excludes 17.65% of the observations"
[1] "   In total, the final dataset has 79.77% of the observations and 93.15% of the market cap in the post  data"
[1] "TWN"
[1] "   Date screen excludes 0% of the observations"
[1] "   Non-missing me and ret_1m excludes 0.97% of the observations"
[1] "   Size screen excludes 0% of the observations"
[1] "   At least 50% of feature excludes 15.98% of the observations"
[1] "   In total, the final dataset has 83.21% of the observations and 86.93% of the market cap in the post  data"
[1] "KOR"
[1] "   Date screen excludes 0% of the observations"
[1] "   Non-missing me and ret_1m excludes 1.2% of the observations"
[1] "   Size screen excludes 0% of the observations"
[1] "   At least 50% of feature excludes 47.58% of the observations"
[1] "   In total, the final dataset has 51.79% of the observations and 86.58% of the market cap in the post  data"
[1] "CAN"
[1] "   Date screen excludes 2.23% of the observations"
[1] "   Non-missing me and ret_1m excludes 54.15% of the observations"
[1] "   Size screen excludes 0% of the observations"
[1] "   At least 50% of feature excludes 26.34% of the observations"
[1] "   In total, the final dataset has 33.77% of the observations and 91.8% of the market cap in the post  data"
[1] "AUS"
[1] "   Date screen excludes 0.02% of the observations"
[1] "   Non-missing me and ret_1m excludes 2.13% of the observations"
[1] "   Size screen excludes 0% of the observations"
[1] "   At least 50% of feature excludes 18% of the observations"
[1] "   In total, the final dataset has 80.25% of the observations and 95.25% of the market cap in the post  data"
[1] "DEU"
[1] "   Date screen excludes 0% of the observations"
[1] "   Non-missing me and ret_1m excludes 1.93% of the observations"
[1] "   Size screen excludes 0% of the observations"
[1] "   At least 50% of feature excludes 27.11% of the observations"
[1] "   In total, the final dataset has 71.49% of the observations and 93.78% of the market cap in the post  data"
[1] "FRA"
[1] "   Date screen excludes 0% of the observations"
[1] "   Non-missing me and ret_1m excludes 2.72% of the observations"
[1] "   Size screen excludes 0% of the observations"
[1] "   At least 50% of feature excludes 23.47% of the observations"
[1] "   In total, the final dataset has 74.45% of the observations and 94.18% of the market cap in the post  data"
[1] "SWE"
[1] "   Date screen excludes 0% of the observations"
[1] "   Non-missing me and ret_1m excludes 1.59% of the observations"
[1] "   Size screen excludes 0% of the observations"
[1] "   At least 50% of feature excludes 10.36% of the observations"
[1] "   In total, the final dataset has 88.22% of the observations and 97.12% of the market cap in the post  data"
[1] "CHE"
[1] "   Date screen excludes 0% of the observations"
[1] "   Non-missing me and ret_1m excludes 1.62% of the observations"
[1] "   Size screen excludes 0% of the observations"
[1] "   At least 50% of feature excludes 17.74% of the observations"
[1] "   In total, the final dataset has 80.92% of the observations and 95.95% of the market cap in the post  data"
[1] "THA"
[1] "   Date screen excludes 0% of the observations"
[1] "   Non-missing me and ret_1m excludes 1.66% of the observations"
[1] "   Size screen excludes 0% of the observations"
[1] "   At least 50% of feature excludes 25.26% of the observations"
[1] "   In total, the final dataset has 73.5% of the observations and 89.71% of the market cap in the post  data"
[1] "IDN"
[1] "   Date screen excludes 0% of the observations"
[1] "   Non-missing me and ret_1m excludes 3.84% of the observations"
[1] "   Size screen excludes 0% of the observations"
[1] "   At least 50% of feature excludes 22.69% of the observations"
[1] "   In total, the final dataset has 74.34% of the observations and 94.06% of the market cap in the post  data"
[1] "BRA"
[1] "   Date screen excludes 0% of the observations"
[1] "   Non-missing me and ret_1m excludes 2.99% of the observations"
[1] "   Size screen excludes 0% of the observations"
[1] "   At least 50% of feature excludes 9.9% of the observations"
[1] "   In total, the final dataset has 87.41% of the observations and 70.69% of the market cap in the post  data"
[1] "SGP"
[1] "   Date screen excludes 0% of the observations"
[1] "   Non-missing me and ret_1m excludes 1.96% of the observations"
[1] "   Size screen excludes 0% of the observations"
[1] "   At least 50% of feature excludes 13.08% of the observations"
[1] "   In total, the final dataset has 85.21% of the observations and 94.37% of the market cap in the post  data"
[1] "MYS"
[1] "   Date screen excludes 0% of the observations"
[1] "   Non-missing me and ret_1m excludes 0.91% of the observations"
[1] "   Size screen excludes 0% of the observations"
[1] "   At least 50% of feature excludes 13.18% of the observations"
[1] "   In total, the final dataset has 86.02% of the observations and 93.15% of the market cap in the post  data"
[1] "ITA"
[1] "   Date screen excludes 0% of the observations"
[1] "   Non-missing me and ret_1m excludes 1.36% of the observations"
[1] "   Size screen excludes 0% of the observations"
[1] "   At least 50% of feature excludes 22.38% of the observations"
[1] "   In total, the final dataset has 76.56% of the observations and 92.64% of the market cap in the post  data"
[1] "ZAF"
[1] "   Date screen excludes 0% of the observations"
[1] "   Non-missing me and ret_1m excludes 2.84% of the observations"
[1] "   Size screen excludes 0% of the observations"
[1] "   At least 50% of feature excludes 38.83% of the observations"
[1] "   In total, the final dataset has 59.43% of the observations and 87.66% of the market cap in the post  data"
[1] "ESP"
[1] "   Date screen excludes 0% of the observations"
[1] "   Non-missing me and ret_1m excludes 2.69% of the observations"
[1] "   Size screen excludes 0% of the observations"
[1] "   At least 50% of feature excludes 28.42% of the observations"
[1] "   In total, the final dataset has 69.65% of the observations and 95.03% of the market cap in the post  data"
[1] "MEX"
[1] "   Date screen excludes 0% of the observations"
[1] "   Non-missing me and ret_1m excludes 4.87% of the observations"
[1] "   Size screen excludes 0% of the observations"
[1] "   At least 50% of feature excludes 21.53% of the observations"
[1] "   In total, the final dataset has 74.65% of the observations and 92.91% of the market cap in the post  data"
[1] "RUS"
[1] "   Date screen excludes 0% of the observations"
[1] "   Non-missing me and ret_1m excludes 4.63% of the observations"
[1] "   Size screen excludes 0% of the observations"
[1] "   At least 50% of feature excludes 25.48% of the observations"
[1] "   In total, the final dataset has 71.07% of the observations and 94.2% of the market cap in the post  data"
[1] "ISR"
[1] "   Date screen excludes 0% of the observations"
[1] "   Non-missing me and ret_1m excludes 2.16% of the observations"
[1] "   Size screen excludes 0% of the observations"
[1] "   At least 50% of feature excludes 26.91% of the observations"
[1] "   In total, the final dataset has 71.51% of the observations and 91.95% of the market cap in the post  data"
[1] "SAU"
[1] "   Date screen excludes 0% of the observations"
[1] "   Non-missing me and ret_1m excludes 1.42% of the observations"
[1] "   Size screen excludes 0% of the observations"
[1] "   At least 50% of feature excludes 11.78% of the observations"
[1] "   In total, the final dataset has 86.96% of the observations and 94.81% of the market cap in the post  data"
[1] "NLD"
[1] "   Date screen excludes 0% of the observations"
[1] "   Non-missing me and ret_1m excludes 1.54% of the observations"
[1] "   Size screen excludes 0% of the observations"
[1] "   At least 50% of feature excludes 26.86% of the observations"
[1] "   In total, the final dataset has 72.02% of the observations and 95.88% of the market cap in the post  data"
[1] "PHL"
[1] "   Date screen excludes 0% of the observations"
[1] "   Non-missing me and ret_1m excludes 3.27% of the observations"
[1] "   Size screen excludes 0% of the observations"
[1] "   At least 50% of feature excludes 27.13% of the observations"
[1] "   In total, the final dataset has 70.49% of the observations and 92.45% of the market cap in the post  data"
[1] "NOR"
[1] "   Date screen excludes 0% of the observations"
[1] "   Non-missing me and ret_1m excludes 2.47% of the observations"
[1] "   Size screen excludes 0% of the observations"
[1] "   At least 50% of feature excludes 19.39% of the observations"
[1] "   In total, the final dataset has 78.62% of the observations and 95.73% of the market cap in the post  data"
[1] "CHL"
[1] "   Date screen excludes 0% of the observations"
[1] "   Non-missing me and ret_1m excludes 6.45% of the observations"
[1] "   Size screen excludes 0% of the observations"
[1] "   At least 50% of feature excludes 24.66% of the observations"
[1] "   In total, the final dataset has 70.48% of the observations and 91.02% of the market cap in the post  data"
[1] "BEL"
[1] "   Date screen excludes 0.05% of the observations"
[1] "   Non-missing me and ret_1m excludes 2.44% of the observations"
[1] "   Size screen excludes 0% of the observations"
[1] "   At least 50% of feature excludes 26.63% of the observations"
[1] "   In total, the final dataset has 71.58% of the observations and 92.49% of the market cap in the post  data"
[1] "TUR"
[1] "   Date screen excludes 0% of the observations"
[1] "   Non-missing me and ret_1m excludes 1% of the observations"
[1] "   Size screen excludes 0% of the observations"
[1] "   At least 50% of feature excludes 27.38% of the observations"
[1] "   In total, the final dataset has 71.89% of the observations and 90.86% of the market cap in the post  data"
[1] "DNK"
[1] "   Date screen excludes 0% of the observations"
[1] "   Non-missing me and ret_1m excludes 1.68% of the observations"
[1] "   Size screen excludes 0% of the observations"
[1] "   At least 50% of feature excludes 22.13% of the observations"
[1] "   In total, the final dataset has 76.56% of the observations and 95.78% of the market cap in the post  data"
[1] "FIN"
[1] "   Date screen excludes 0% of the observations"
[1] "   Non-missing me and ret_1m excludes 1.24% of the observations"
[1] "   Size screen excludes 0% of the observations"
[1] "   At least 50% of feature excludes 12.18% of the observations"
[1] "   In total, the final dataset has 86.73% of the observations and 97.43% of the market cap in the post  data"
[1] "ARE"
[1] "   Date screen excludes 0% of the observations"
[1] "   Non-missing me and ret_1m excludes 6% of the observations"
[1] "   Size screen excludes 0% of the observations"
[1] "   At least 50% of feature excludes 33.93% of the observations"
[1] "   In total, the final dataset has 62.11% of the observations and 80.43% of the market cap in the post  data"
[1] "POL"
[1] "   Date screen excludes 0% of the observations"
[1] "   Non-missing me and ret_1m excludes 1.85% of the observations"
[1] "   Size screen excludes 0% of the observations"
[1] "   At least 50% of feature excludes 17.06% of the observations"
[1] "   In total, the final dataset has 81.4% of the observations and 94.75% of the market cap in the post  data"
[1] "NZL"
[1] "   Date screen excludes 0% of the observations"
[1] "   Non-missing me and ret_1m excludes 1.93% of the observations"
[1] "   Size screen excludes 0% of the observations"
[1] "   At least 50% of feature excludes 27.73% of the observations"
[1] "   In total, the final dataset has 70.88% of the observations and 92% of the market cap in the post  data"
[1] "AUT"
[1] "   Date screen excludes 0% of the observations"
[1] "   Non-missing me and ret_1m excludes 2.74% of the observations"
[1] "   Size screen excludes 0% of the observations"
[1] "   At least 50% of feature excludes 32.5% of the observations"
[1] "   In total, the final dataset has 65.65% of the observations and 91.54% of the market cap in the post  data"
[1] "QAT"
[1] "   Date screen excludes 0% of the observations"
[1] "   Non-missing me and ret_1m excludes 0.86% of the observations"
[1] "   Size screen excludes 0% of the observations"
[1] "   At least 50% of feature excludes 18.95% of the observations"
[1] "   In total, the final dataset has 80.36% of the observations and 87.5% of the market cap in the post  data"
[1] "PER"
[1] "   Date screen excludes 0% of the observations"
[1] "   Non-missing me and ret_1m excludes 8.82% of the observations"
[1] "   Size screen excludes 0% of the observations"
[1] "   At least 50% of feature excludes 28.02% of the observations"
[1] "   In total, the final dataset has 65.64% of the observations and 89.8% of the market cap in the post  data"
[1] "COL"
[1] "   Date screen excludes 0% of the observations"
[1] "   Non-missing me and ret_1m excludes 5.08% of the observations"
[1] "   Size screen excludes 0% of the observations"
[1] "   At least 50% of feature excludes 35.14% of the observations"
[1] "   In total, the final dataset has 61.57% of the observations and 89.88% of the market cap in the post  data"
[1] "GRC"
[1] "   Date screen excludes 0% of the observations"
[1] "   Non-missing me and ret_1m excludes 2.49% of the observations"
[1] "   Size screen excludes 0% of the observations"
[1] "   At least 50% of feature excludes 31.71% of the observations"
[1] "   In total, the final dataset has 66.59% of the observations and 83.13% of the market cap in the post  data"
[1] "PAK"
[1] "   Date screen excludes 0% of the observations"
[1] "   Non-missing me and ret_1m excludes 3.78% of the observations"
[1] "   Size screen excludes 0% of the observations"
[1] "   At least 50% of feature excludes 28.5% of the observations"
[1] "   In total, the final dataset has 68.8% of the observations and 89.32% of the market cap in the post  data"
[1] "IRL"
[1] "   Date screen excludes 0% of the observations"
[1] "   Non-missing me and ret_1m excludes 7.07% of the observations"
[1] "   Size screen excludes 0% of the observations"
[1] "   At least 50% of feature excludes 23.26% of the observations"
[1] "   In total, the final dataset has 71.31% of the observations and 95.2% of the market cap in the post  data"
[1] "EGY"
[1] "   Date screen excludes 0% of the observations"
[1] "   Non-missing me and ret_1m excludes 2.8% of the observations"
[1] "   Size screen excludes 0% of the observations"
[1] "   At least 50% of feature excludes 34.94% of the observations"
[1] "   In total, the final dataset has 63.24% of the observations and 81.08% of the market cap in the post  data"
[1] "ARG"
[1] "   Date screen excludes 0% of the observations"
[1] "   Non-missing me and ret_1m excludes 4.41% of the observations"
[1] "   Size screen excludes 0% of the observations"
[1] "   At least 50% of feature excludes 28.57% of the observations"
[1] "   In total, the final dataset has 68.28% of the observations and 45.19% of the market cap in the post  data"
[1] "PRT"
[1] "   Date screen excludes 0% of the observations"
[1] "   Non-missing me and ret_1m excludes 3.21% of the observations"
[1] "   Size screen excludes 0% of the observations"
[1] "   At least 50% of feature excludes 32.36% of the observations"
[1] "   In total, the final dataset has 65.47% of the observations and 93.24% of the market cap in the post  data"
[1] "CZE"
[1] "   Date screen excludes 0% of the observations"
[1] "   Non-missing me and ret_1m excludes 9.1% of the observations"
[1] "   Size screen excludes 0% of the observations"
[1] "   At least 50% of feature excludes 78.28% of the observations"
[1] "   In total, the final dataset has 19.74% of the observations and 88.36% of the market cap in the post  data"
[1] "HUN"
[1] "   Date screen excludes 0% of the observations"
[1] "   Non-missing me and ret_1m excludes 3.89% of the observations"
[1] "   Size screen excludes 0% of the observations"
[1] "   At least 50% of feature excludes 50.55% of the observations"
[1] "   In total, the final dataset has 47.53% of the observations and 92.54% of the market cap in the post  data"

> if (set$feat_prank) {
+     chars[, `:=`((features), lapply(.SD, as.double)), .SDcols = features]
+     for (f in features) {
+         if (match(f, .... [TRUNCATED] 
[1] "Feature 10 out of 154"
[1] "Feature 20 out of 154"
[1] "Feature 30 out of 154"
[1] "Feature 40 out of 154"
[1] "Feature 50 out of 154"
[1] "Feature 60 out of 154"
[1] "Feature 70 out of 154"
[1] "Feature 80 out of 154"
[1] "Feature 90 out of 154"
[1] "Feature 100 out of 154"
[1] "Feature 110 out of 154"
[1] "Feature 120 out of 154"
[1] "Feature 130 out of 154"
[1] "Feature 140 out of 154"
[1] "Feature 150 out of 154"

> if (set$feat_impute) {
+     if (set$feat_prank) {
+         chars[, `:=`((features), lapply(.SD, function(x) if_else(is.na(x), 
+             0.5,  .... [TRUNCATED] 

> clusters <- unique(char_info$cluster)

> cluster_ranks <- clusters %>% map(function(cl) {
+     chars_sub <- char_info[cluster == cl]
+     data_sub <- chars[, chars_sub$characteristic, wit .... [TRUNCATED] 

> chars <- cbind(chars[, .(excntry, id, eom, rvol_perc = rvol_252d, 
+     me_perc = market_equity, me, ret_exc_lead1m)], cluster_ranks)

> chars[, `:=`((clusters), lapply(.SD, function(x) ecdf(x)(x))), 
+     .SDcols = clusters, by = eom]
[1] "Value: 1 of 34"
[1] "Low risk: 2 of 34"
[1] "Momentum: 3 of 34"
[1] "Illiquidity: 4 of 34"
[1] "Long-run reversal: 5 of 34"
[1] "Size: 6 of 34"
[1] "Profitability: 7 of 34"
[1] "Fundamental growth: 8 of 34"
[1] "Accruals: 9 of 34"
[1] "Information quality: 10 of 34"
[1] "Short-term reversal: 11 of 34"
[1] "Skewness: 12 of 34"
[1] "R&D: 13 of 34"
[1] "Leverage: 14 of 34"
[1] "Investment: 15 of 34"
[1] "Asset growth: 16 of 34"
[1] "Combinations (quality): 17 of 34"
[1] "Financial constraints: 18 of 34"
[1] "PEAD: 19 of 34"
[1] "Low default risk: 20 of 34"
[1] "Equity issuance: 21 of 34"
[1] "Earnings increases: 22 of 34"
[1] "Combinations (mispricing): 23 of 34"
[1] "Taxes and returns: 24 of 34"
[1] "Firm issuance: 25 of 34"
[1] "Debt issuance: 26 of 34"
[1] "Age: 27 of 34"
[1] "Operating leverage: 28 of 34"
[1] "cash holdings: 29 of 34"
[1] "Duration: 30 of 34"
[1] "Seasonality: 31 of 34"
[1] "Real asset illiquidity: 32 of 34"
[1] "Inventory growth: 33 of 34"
[1] "Tax growth: 34 of 34"
